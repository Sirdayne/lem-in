<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lem-in</title>
</head>
<body>
    <svg id="container" height="550" width="750"></svg>
    <div class="controls">
        <button onclick="START_LEMIN()">RUN</button>
    </div>
</body>
</html>

<script>
    let rooms = [
        {
            name: '1',
            x: 23,
            y: 3,
            links: ['3'],
            status: 'start'
        },
        {
            name: '2',
            x: 16,
            y: 7,
            links: ['1']
        },
        {
            name: '3',
            x: 16,
            y: 3,
            links: ['5']
        },
        {
            name: '4',
            x: 16,
            y: 5,
            links: ['3', '2']
        },
        {
            name: '5',
            x: 9,
            y: 3,
            links: ['2']
        },
        {
            name: '6',
            x: 1,
            y: 5,
            links: ['5']
        },
        {
            name: '7',
            x: 4,
            y: 8,
            links: ['6', '2', '4']
        },
        {
            name: '0',
            x: 9,
            y: 5,
            links: ['4', '6'],
            status: 'end'
        }
    ]

    rooms = [
        {
            name: 'start',
            x: 1,
            y: 6,
            links: ['t', 'h', '0'],
            status: 'start'
        },
        {
            name: '0',
            x: 4,
            y: 8,
            links: ['o'],
        },
        {
            name: 'o',
            x: 6,
            y: 8,
            links: ['n'],
        },
        {
            name: 'n',
            x: 6,
            y: 6,
            links: ['e', 'm'],
        },
        {
            name: 'e',
            x: 8,
            y: 4,
            links: ['end'],
        },
        {
            name: 't',
            x: 1,
            y: 9,
            links: ['E'],
        },
        {
            name: 'E',
            x: 5,
            y: 9,
            links: ['a'],
        },
        {
            name: 'a',
            x: 8,
            y: 9,
            links: ['m'],
        },
        {
            name: 'm',
            x: 8,
            y: 6,
            links: ['end'],
        },
        {
            name: 'h',
            x: 4,
            y: 6,
            links: ['A', 'n'],
        },
        {
            name: 'A',
            x: 5,
            y: 2,
            links: ['c'],
        },
        {
            name: 'c',
            x: 8,
            y: 1,
            links: ['k'],
        },
        {
            name: 'k',
            x: 11,
            y: 2,
            links: ['end'],
        },
        {
            name: 'end',
            x: 11,
            y: 6,
            status: 'end'
        },
    ]

    const SVGNS = "http://www.w3.org/2000/svg"
    let container = document.getElementById('container');

    let WIDTH = 0
    let HEIGHT = 0

    rooms.forEach(room => {
        WIDTH = room.x > WIDTH ? room.x : WIDTH
        HEIGHT = room.y > HEIGHT ? room.y : HEIGHT
    })

    const SVG_WIDTH = 700
    const SVG_HEIGHT = 500
    const X_FACTOR = WIDTH ? SVG_WIDTH / WIDTH : 0;
    const Y_FACTOR = HEIGHT ? SVG_HEIGHT / HEIGHT : 0;

    function addLink(x1, y1, x2, y2) {
        let newLink = document.createElementNS(SVGNS, 'line');
        newLink.setAttribute('x1', x1 * X_FACTOR);
        newLink.setAttribute('y1', y1 * Y_FACTOR);
        newLink.setAttribute('x2', x2 * X_FACTOR);
        newLink.setAttribute('y2', y2 * Y_FACTOR);
        newLink.setAttribute('style', 'stroke:#424242; stroke-width: 5;');
        container.appendChild(newLink);
    }

    function addRoom(x, y, name, links) {
        let newRoom = document.createElementNS(SVGNS, 'circle');
        newRoom.setAttribute('cx', x * X_FACTOR);
        newRoom.setAttribute('cy', y * Y_FACTOR);
        newRoom.setAttribute('r', 15);
        newRoom.setAttribute('fill', '#424242');
        container.appendChild(newRoom);
        
        if (links) {
            links.forEach(link => {
                let found = rooms.find(room => room.name === link)
                addLink(x, y, found.x, found.y)
            })
        }
    }

    function DRAW_MAP () {
        rooms.forEach(room => {
            addRoom(room.x, room.y, room.name, room.links)
        })
    }

    let results = [
        ['L1-3', 'L2-2'],
        ['L1-4', 'L2-5', 'L3-3'],
        ['L1-0', 'L2-6', 'L3-4'],
        ['L2-0', 'L3-0']
    ]

    results = [
        'L1-t L2-h L3-0',
        'L1-E L2-A L3-o L4-t L5-h L6-0',
        'L1-a L2-c L3-n L4-E L5-A L6-o L7-t L8-h L9-0',
        'L1-m L2-k L3-e L4-a L5-c L6-n L7-E L8-A L9-o L10-t',
        'L1-end L2-end L3-end L4-m L5-k L6-e L7-a L8-c L9-n L10-E',
        'L4-end L5-end L6-end L7-m L8-k L9-e L10-a',
        'L7-end L8-end L9-end L10-m',
        'L10-end'
    ]

    let start = rooms.find(room => room.status === 'start')
    let end = rooms.find(room => room.status === 'end')

    function createLemin (nameLemin) {
        let newLemin = document.createElementNS(SVGNS, 'circle');
        newLemin.setAttribute('id', nameLemin);
        let found = rooms.find(room => room.name === start.name)
        newLemin.setAttribute('cx', found.x * X_FACTOR);
        newLemin.setAttribute('cy', found.y * Y_FACTOR);
        newLemin.setAttribute('r', 10);
        newLemin.setAttribute('fill', "#"+((1<<24)*Math.random()|0).toString(16));
        newLemin.setAttribute('stroke', '#fff');
        newLemin.setAttribute('stroke-width', '2');
        newLemin.setAttribute('class', 'lemins')
        container.appendChild(newLemin);
    }

    const TIME_STEP = 1100

    function moveLemin (nameLemin, startName, endName, time) {
        let lemin = document.getElementById(nameLemin)
        let startFound = rooms.find(room => room.name === startName)
        let endFound = rooms.find(room => room.name === endName)

        let steps = 100;
        let timelapse = TIME_STEP / steps;
        let x = startFound.x;
        let y = startFound.y;

        let rangeX = Math.abs(endFound.x - startFound.x) / steps
        let rangeY = Math.abs(endFound.y - startFound.y) / steps
    
        let step = 0

        for (let i = 0; i < steps; i++) {
            time = time + timelapse
            setTimeout(() => {
                if (endFound.y === startFound.y) {
                    y = startFound.y
                    x = endFound.x > startFound.x ? x = x + rangeX : x = x - rangeX
                } else if (endFound.x === startFound.x) {
                    x = startFound.x
                    y = endFound.y > startFound.y ? y = y + rangeY : y = y - rangeY
                } else {
                    let FACTOR = (endFound.y - startFound.y) / (endFound.x - startFound.x)
                    y = (x - startFound.x) * FACTOR + startFound.y;
                    x = endFound.x > startFound.x ? x = x + rangeX : x = x - rangeX
                }
                if (i === steps - 1) {
                   x = endFound.x
                   y = endFound.y
                }
                lemin.setAttribute('cx', x * X_FACTOR);
                lemin.setAttribute('cy', y * Y_FACTOR);
            }, time)
        }
    }

    // function moveLemin (nameLemin, startName, endName, time) {
    //     let lemin = document.getElementById(nameLemin)
    //     let endFound = rooms.find(room => room.name === endName)

    //     let x = endFound.x;
    //     let y = endFound.y;
    //     setTimeout(() => {
    //         lemin.setAttribute('cx', x * X_FACTOR)
    //         lemin.setAttribute('cy', y * Y_FACTOR)
    //     }, TIME_STEP * step)
    // }

    let lemins = []

    function RESET_LEMIN() {
        lemins.forEach(lemin => {
            let node = document.getElementById(lemin.name)
            node.remove()
        })
        lemins = []
        step = 0
    }

    const newResults = []
    results.forEach(res => newResults.push(res.split(' ')))

    let step = 0

    function START_LEMIN() {
        RESET_LEMIN()
        newResults.forEach(positions => {
            step++;
            positions.forEach(pos => {
                let [ name, room ] = pos.split('-')
                let found = lemins.find(lemin => lemin.name === name)
                if (!found) {
                    let lemin = {
                        name: name,
                        room: room
                    }
                    lemins.push(lemin)
                    createLemin(name)
                    moveLemin(name, start.name, room, TIME_STEP * step)
                } else { 
                    moveLemin(name, found.room, room, TIME_STEP * step)   
                    found.room = room
                }
            })
        })
    }

    DRAW_MAP()

</script>

<!-- <script>

    let lemins = [
        [1, 2, 4, 6, 9],
        [3, 5, 8, null, null],
        [7, 10, null, null, null]
    ]

    let rooms = [
        [null, null, 7, 4, 1],
        [null, 12, 8, 5, 2],
        [13, 14, 9, 6, 3]
    ]

    let out = []
    let paths = ''

    const SIZE = lemins.length;
    const LENGTH = lemins[0].length;

    for (var step = 1; step <= LENGTH*2; step++) {
        paths = ''
        for(var leminStep = 0; leminStep < step; leminStep++) {
            for (var i = 0; i < SIZE; i++) {
                if (lemins[i][leminStep] && rooms[i][LENGTH - step + leminStep]) {
                    let path = `L${lemins[i][leminStep]}-${rooms[i][LENGTH - step + leminStep]} `
                    paths += path
                }

            }
        }
        paths = paths.slice(0, -1)
        if (paths) {
         out.push(paths)
        }
    }
    console.log(out)

</script> -->

<style>
    body { 
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #container {
        margin-top: 50px;
        border: 1px solid #fff;
    }
</style>